generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  USER
  ADMIN
}

model User {
  id               String    @id @default(cuid())
  role             Role      @default(USER)
  name             String?   @db.VarChar(100)
  email            String    @unique @db.VarChar(255)
  emailVerified    Boolean   @default(false)
  image            String?
  stripeCustomerId String?   @unique
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @default(now()) @updatedAt
  deletedAt        DateTime?

  sessions       Session[]
  accounts       Account[]
  orders         Order[]
  cart           Cart?
  addresses      Address[]
  wishlist       Wishlist?
  discountUsages DiscountUsage[]

  // Indexes optimis√©s
  @@index([deletedAt])
  @@index([role, id])
  @@index([emailVerified, id])
  @@index([createdAt, id])
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@index([userId, expiresAt])
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@index([providerId, accountId])
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@index([identifier])
}

model Address {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  firstName  String
  lastName   String
  address1   String
  address2   String?
  postalCode String  @db.VarChar(10)
  city       String
  country    String  @default("FR") @db.VarChar(2)
  phone      String

  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Note: Contrainte unique partielle ajout√©e via migration SQL brute
  // pour garantir qu'un seul enregistrement a isDefault: true par userId

  @@index([userId])
  @@index([userId, isDefault])
  @@index([userId, createdAt(sort: Desc)])
}

model ProductType {
  id          String  @id @default(cuid())
  slug        String  @unique
  label       String  @db.VarChar(50)
  description String? @db.Text
  isActive    Boolean @default(true)
  isSystem    Boolean @default(false) // Types syst√®me non modifiables/supprimables

  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([label, id])
}

enum ProductStatus {
  DRAFT
  PUBLIC
  ARCHIVED
}

enum CollectionStatus {
  DRAFT
  PUBLIC
  ARCHIVED
}

model Color {
  id        String       @id @default(cuid())
  slug      String       @unique
  name      String       @unique @db.VarChar(50)
  hex       String       @db.VarChar(7)
  skus      ProductSku[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name, id])
}

model Collection {
  id          String           @id @default(cuid())
  name        String           @db.VarChar(100)
  slug        String           @unique
  description String?          @db.Text
  imageUrl    String?
  status      CollectionStatus @default(DRAFT)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  products  Product[]

  @@index([name, id])
  @@index([createdAt, id])
  @@index([status, id])
}

model Product {
  id          String        @id @default(cuid())
  slug        String        @unique
  title       String        @db.VarChar(200)
  description String?       @db.Text
  status      ProductStatus @default(PUBLIC)

  type   ProductType? @relation(fields: [typeId], references: [id], onDelete: SetNull)
  typeId String?

  collection   Collection? @relation(fields: [collectionId], references: [id], onDelete: SetNull)
  collectionId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  skus       ProductSku[]
  orderItems OrderItem[]

  @@index([status])
  @@index([status, id])
  @@index([title, id])
  @@index([typeId])
  @@index([collectionId])
  @@index([createdAt, id])
}

model ProductSku {
  id        String  @id @default(cuid())
  sku       String  @unique @db.VarChar(100)
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  colorId  String?
  color    Color?  @relation(fields: [colorId], references: [id], onDelete: SetNull)
  material String? @db.VarChar(100)

  size String? @db.VarChar(50)

  // ‚ÑπÔ∏è Prix en r√©gime micro-entreprise (exon√©r√© de TVA - art. 293 B du CGI)
  // Le nom "priceInclTax" est conserv√© pour compatibilit√©, mais il s'agit du prix FINAL sans TVA
  // Exemple : 30‚Ç¨ = 3000 centimes (prix que paie le client, sans TVA ajout√©e)
  priceInclTax   Int
  compareAtPrice Int? // Prix avant r√©duction (optionnel, pour afficher prix barr√©)
  inventory      Int     @default(0)
  isActive       Boolean @default(true)

  isDefault Boolean @default(false)

  images        SkuMedia[]
  orderItems    OrderItem[]
  cartItems     CartItem[]
  wishlistItems WishlistItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // üîí CONTRAINTE : Garantir unicit√© des combinaisons produit/couleur/taille/mat√©riau
  // √âvite les doublons de variantes (ex: 2 SKUs "Bague Rouge Taille 52 Argent")
  @@unique([productId, colorId, size, material])
  // Indexes optimis√©s pour requ√™tes fr√©quentes
  @@index([productId, isActive])
  @@index([isActive, inventory, updatedAt(sort: Desc)])
  @@index([isActive, priceInclTax])
  @@index([productId, isDefault])
}

enum MediaType {
  IMAGE
  VIDEO
}

model SkuMedia {
  id    String     @id @default(cuid())
  skuId String
  sku   ProductSku @relation(fields: [skuId], references: [id], onDelete: Cascade)

  url       String
  altText   String?
  mediaType MediaType @default(IMAGE)
  isPrimary Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([skuId, isPrimary])
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum InvoiceStatus {
  PENDING        // Commande pay√©e, facture en attente de g√©n√©ration Stripe
  DRAFT          // Facture cr√©√©e mais pas encore finalis√©e (brouillon)
  OPEN           // Facture finalis√©e, en attente de paiement
  FINALIZED      // Facture finalis√©e avec num√©ro s√©quentiel attribu√©
  PAID           // Facture pay√©e avec succ√®s
  UNCOLLECTIBLE  // Facture marqu√©e comme irr√©cup√©rable
  VOID           // Facture annul√©e
  PAYMENT_FAILED // √âchec de paiement de la facture
  GENERATED      // @deprecated - Utiliser FINALIZED √† la place
}

enum PaymentMethod {
  CARD
  BANK_TRANSFER
  PAYPAL
  OTHER
}

enum FulfillmentStatus {
  UNFULFILLED
  PROCESSING
  SHIPPED
  DELIVERED
  RETURNED
}

// ============================================================================
// REMBOURSEMENTS
// ============================================================================

enum RefundReason {
  CUSTOMER_REQUEST // Droit de r√©tractation (14 jours)
  DEFECTIVE // Bijou cass√© / ab√Æm√©
  WRONG_ITEM // Erreur de pr√©paration de commande
  LOST_IN_TRANSIT // Colis perdu par le transporteur
  FRAUD // Fraude av√©r√©e
  OTHER // Autre
}

enum RefundStatus {
  PENDING // Demande re√ßue / En attente de validation
  APPROVED // Valid√©, en attente de traitement Stripe
  COMPLETED // Rembours√© effectivement (Stripe a confirm√©)
  REJECTED // Refus√© (ex: retour hors d√©lai)
  FAILED // √âchec technique Stripe
}

model Order {
  id          String  @id @default(cuid())
  orderNumber String  @unique @db.VarChar(50)
  userId      String?
  user        User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // === IDENTIFIANTS STRIPE (CRITIQUES) ===
  stripeCheckoutSessionId String? @unique // cs_xxx
  stripePaymentIntentId   String? @unique // pi_xxx
  stripeChargeId          String? // ch_xxx
  stripeCustomerId        String? // cus_xxx
  stripeInvoiceId         String? @unique // in_xxx
  // ‚ö†Ô∏è PR√âPARATION TVA R√âGIME R√âEL : Champ conserv√© pour future activation de Stripe Tax
  // En micro-entreprise (CA < 91 900‚Ç¨/an), ce champ reste null
  // Si passage en r√©gime r√©el TVA (> seuil), activer Stripe Tax et ce champ sera rempli
  stripeTaxCalculationId  String? // txcalc_xxx - ID Stripe Tax pour r√©conciliation

  // === INFORMATIONS CLIENT ===
  customerEmail String @db.VarChar(255)
  customerName  String @db.VarChar(200)
  customerPhone String?

  // === ADRESSE DE LIVRAISON (D√âNORMALIS√âE - SNAPSHOT) ===
  shippingFirstName  String
  shippingLastName   String
  shippingAddress1   String
  shippingAddress2   String?
  shippingPostalCode String  @db.VarChar(10)
  shippingCity       String
  shippingCountry    String  @default("FR") @db.VarChar(2)
  shippingPhone      String

  // === ADRESSE DE FACTURATION (D√âNORMALIS√âE - SNAPSHOT) ===
  billingFirstName  String
  billingLastName   String
  billingAddress1   String
  billingAddress2   String?
  billingPostalCode String  @db.VarChar(10)
  billingCity       String
  billingCountry    String  @default("FR") @db.VarChar(2)
  billingPhone      String?

  // === MONTANTS (EN CENTIMES) ===
  subtotal       Int
  discountAmount Int    @default(0) // Montant total des r√©ductions appliqu√©es
  taxAmount      Int    @default(0) // ‚ùå Micro-entreprise : Toujours 0 (exon√©r√©e de TVA - art. 293 B du CGI)
  shippingCost   Int    @default(0) // Frais de livraison
  total          Int // Formule: MAX(0, subtotal - discountAmount + shippingCost + taxAmount)
  currency       String @default("eur") @db.VarChar(3)

  // === D√âTAILS FISCAUX (INUTILIS√âS EN MICRO-ENTREPRISE) ===
  // ‚ö†Ô∏è Ces champs sont conserv√©s pour compatibilit√© et future migration en r√©gime r√©el TVA
  // En micro-entreprise (CA < 91 900‚Ç¨/an), ces champs restent null ou 0
  // Si passage en r√©gime r√©el TVA (> seuil), r√©activer Stripe Tax et ces champs seront remplis
  taxRate         Decimal? @db.Decimal(5, 4) // ‚ùå Micro-entreprise : null (pas de TVA)
  taxJurisdiction String? // ‚ùå Micro-entreprise : null
  taxType         String? // ‚ùå Micro-entreprise : null
  taxDetails      Json? // ‚ùå Micro-entreprise : null (pas de Stripe Tax)

  // === PR√âPARATION R√âGIME R√âEL TVA ===
  // Ces champs pr√©parent la migration vers le r√©gime r√©el TVA (seuil 85 000‚Ç¨)
  customerTaxId String? // N¬∞ TVA client B2B (ex: FR12345678901 pour ventes B2B)
  taxBehavior   String  @default("inclusive") // Stripe Tax: "inclusive" ou "exclusive"
  reverseCharge Boolean @default(false) // Autoliquidation TVA pour ventes B2B UE

  // === LIVRAISON ===
  shippingMethod    String? // "Colissimo France"
  shippingCarrier   String? @db.VarChar(50)
  shippingRateId    String? // ID du tarif Stripe utilis√©
  trackingNumber    String? @db.VarChar(50)
  trackingUrl       String? // URL de suivi
  estimatedDelivery DateTime? // Date estim√©e de livraison
  actualDelivery    DateTime? // Date r√©elle de livraison
  shippedAt         DateTime? // Date d'exp√©dition

  // === STATUTS ===
  status            OrderStatus       @default(PENDING)
  paymentStatus     PaymentStatus     @default(PENDING)
  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED)

  // === PAIEMENT ===
  paymentMethod PaymentMethod @default(CARD)
  paidAt        DateTime?

  // === FACTURATION (STRIPE INVOICING) ===
  // ‚úÖ Stripe g√©n√®re automatiquement les factures PDF avec invoice_creation
  invoiceNumber      String?       @unique // Num√©ro Stripe (ex: INV-XXXX)
  invoiceGeneratedAt DateTime? // Date de g√©n√©ration automatique par Stripe
  invoiceStatus      InvoiceStatus @default(PENDING)

  // === CONFORMIT√â L√âGALE FRAN√áAISE ===
  // Obligation de conservation 10 ans (Art. L123-22 Code de commerce)
  operationCategory String @default("goods") // "goods" | "services" | "mixed" (depuis juillet 2024)
  fiscalYear        Int? // Ann√©e fiscale de la commande

  // === RELATIONS ===
  items          OrderItem[]
  discountUsages DiscountUsage[]
  refunds        Refund[]
  statusHistory  OrderStatusHistory[] // Historique des changements de statut

  // === SOFT DELETE (Conformit√© l√©gale - Conservation 10 ans) ===
  // Ne JAMAIS supprimer physiquement une commande (Art. L123-22 Code de Commerce)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // === INDEXES OPTIMIS√âS ===
  @@index([userId])
  // Statuts (index composites uniquement, supprim√© les index simples redondants)
  @@index([status, id])
  @@index([paymentStatus, id])
  @@index([fulfillmentStatus, id])
  // Montants
  @@index([total, id])
  // Chronologique
  @@index([userId, createdAt(sort: Desc)])
  @@index([userId, paymentStatus, createdAt(sort: Desc)]) // Covering index "Mes commandes"
  @@index([status, createdAt])
  @@index([createdAt, id])
  @@index([paymentStatus, createdAt])
  @@index([customerEmail]) // Recherche support client
  @@index([fiscalYear]) // Conformit√© l√©gale
  @@index([deletedAt]) // Soft delete filter

  // === INDEXES STRIPE (R√©conciliation & Support) ===
  @@index([stripePaymentIntentId])
  @@index([stripeCheckoutSessionId])
  @@index([stripeCustomerId])
}

model OrderItem {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  skuId String
  sku   ProductSku @relation(fields: [skuId], references: [id], onDelete: Restrict)

  // Snapshot des donn√©es produit au moment de la commande
  productTitle       String
  productDescription String? @db.Text
  productImageUrl    String?

  skuColor    String?
  skuMaterial String?
  skuSize     String?
  skuImageUrl String?

  // Prix et quantit√©
  price    Int // ‚ÑπÔ∏è Prix unitaire FINAL sans TVA en centimes (micro-entreprise exon√©r√©e)
  quantity Int

  // D√©tails fiscaux (inutilis√©s en micro-entreprise)
  // ‚ö†Ô∏è Conserv√©s pour compatibilit√© et future migration en r√©gime r√©el TVA
  taxAmount Int      @default(0) // ‚ùå Micro-entreprise : Toujours 0 (pas de TVA)
  taxRate   Decimal? @db.Decimal(5, 4) // ‚ùå Micro-entreprise : null (pas de TVA)

  // Relations
  refundItems RefundItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([productId])
  @@index([skuId])
  @@index([productId, orderId]) // Analytics top produits
}

model Cart {
  id String @id @default(cuid())

  userId    String? @unique
  user      User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId String? @unique

  expiresAt DateTime?

  items CartItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([expiresAt])
}

model CartItem {
  id     String @id @default(cuid())
  cartId String
  cart   Cart   @relation(fields: [cartId], references: [id], onDelete: Cascade)

  skuId String
  sku   ProductSku @relation(fields: [skuId], references: [id], onDelete: Cascade)

  quantity Int @default(1)

  // Prix snapshot au moment de l'ajout au panier (en centimes)
  // Prot√®ge contre les changements de prix entre l'ajout et le paiement
  // Exemple: 29,99‚Ç¨ = 2999 centimes
  priceAtAdd Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, skuId])
  @@index([cartId])
  @@index([skuId])
}

model NewsletterSubscriber {
  id               String  @id @default(cuid())
  email            String  @unique
  isActive         Boolean @default(false) // ‚ö†Ô∏è Changement : false par d√©faut (activation apr√®s confirmation email)
  unsubscribeToken String  @unique @default(cuid())

  // Double opt-in : Confirmation email obligatoire
  emailVerified      Boolean   @default(false) // true apr√®s clic sur lien confirmation
  confirmationToken  String?   @unique // Token unique pour confirmer l'inscription
  confirmationSentAt DateTime? // Date d'envoi de l'email de confirmation
  confirmedAt        DateTime? // Date de confirmation par l'utilisateur

  // Champs de tra√ßabilit√© RGPD
  ipAddress        String?
  userAgent        String?
  consentSource    String?  @default("newsletter_form")
  consentTimestamp DateTime @default(now())

  subscribedAt   DateTime  @default(now())
  unsubscribedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive, createdAt])
  @@index([emailVerified, isActive])
}

model Wishlist {
  id String @id @default(cuid())

  // Support utilisateur connect√© uniquement
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  items WishlistItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

}

model WishlistItem {
  id         String   @id @default(cuid())
  wishlistId String
  wishlist   Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)

  skuId String
  sku   ProductSku @relation(fields: [skuId], references: [id], onDelete: Cascade)

  // Prix snapshot au moment de l'ajout (pour notifier si baisse de prix)
  priceAtAdd Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Un SKU ne peut √™tre ajout√© qu'une seule fois par wishlist
  @@unique([wishlistId, skuId])
  @@index([wishlistId])
  @@index([skuId])
}

// ============================================
// CODES PROMO & R√âDUCTIONS
// ============================================

enum DiscountType {
  PERCENTAGE    // Ex: -20%
  FIXED_AMOUNT  // Ex: -10‚Ç¨
}

model Discount {
  id   String @id @default(cuid())
  code String @unique @db.VarChar(30) // Ex: "BIENVENUE10", "ETE2025"

  // Type et valeur de la r√©duction
  type  DiscountType
  value Int // En pourcentage (20 = 20%) ou centimes (1000 = 10‚Ç¨)

  // Conditions d'utilisation
  minOrderAmount Int? // Montant minimum de commande en centimes (ex: 5000 = 50‚Ç¨)
  maxUsageCount  Int? // Nombre max d'utilisations total (null = illimit√©)
  maxUsagePerUser Int? // Nombre max d'utilisations par utilisateur (null = illimit√©)

  // P√©riode de validit√©
  startsAt DateTime  @default(now())
  endsAt   DateTime?

  // Statistiques
  usageCount Int @default(0) // Compteur d'utilisations

  // √âtat
  isActive  Boolean   @default(true)

  // Restrictions optionnelles (√† impl√©menter si besoin)
  // appliesToCollectionId String?
  // appliesToProductId    String?
  // firstOrderOnly        Boolean @default(false)

  // Relations
  usages DiscountUsage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([isActive, startsAt, endsAt])
  @@index([createdAt, id])
}

model DiscountUsage {
  id         String   @id @default(cuid())
  discountId String
  discount   Discount @relation(fields: [discountId], references: [id], onDelete: Cascade)

  // Utilisateur (optionnel pour guest checkout)
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Commande associ√©e (Restrict pour protection comptable)
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Restrict)

  // Montant de la r√©duction appliqu√©e (snapshot)
  amountApplied Int // En centimes

  createdAt DateTime @default(now())

  @@index([discountId])
  @@index([userId])
  @@index([orderId])
  @@index([discountId, userId]) // Pour v√©rifier usage par utilisateur
}

// ============================================================================
// REMBOURSEMENTS
// ============================================================================

model Refund {
  id String @id @default(cuid())

  // Relation avec la commande (Restrict pour protection comptable)
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Restrict)

  // Identifiant Stripe du remboursement (pour lier la compta)
  stripeRefundId String? @unique // re_xxxx

  // Montants
  amount   Int    // Montant TOTAL rembours√© en centimes
  currency String @default("eur") @db.VarChar(3)

  // Raison et Statut
  reason RefundReason
  status RefundStatus @default(PENDING)

  // Note interne (ex: "Le fermoir √©tait cass√©, photos re√ßues par mail")
  note String? @db.Text

  // D√©tails des articles rembours√©s
  items RefundItem[]

  // Audit
  createdBy   String? // ID de l'admin qui a cr√©√© le remboursement
  processedAt DateTime? // Date de traitement effectif (Stripe)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // === SOFT DELETE (Conformit√© l√©gale - Conservation 10 ans) ===
  // Ne JAMAIS supprimer physiquement un remboursement (Art. L123-22 Code de Commerce)
  deletedAt DateTime?

  @@index([orderId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([status, createdAt])
  @@index([deletedAt])
}

model RefundItem {
  id String @id @default(cuid())

  refundId String
  refund   Refund @relation(fields: [refundId], references: [id], onDelete: Cascade)

  // Lien pr√©cis vers la ligne de commande d'origine
  // Cela permet de savoir quel produit exact (et √† quel prix d'origine) est rembours√©
  orderItemId String
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Restrict)

  quantity Int // Nombre d'unit√©s rembours√©es (ex: 1 sur 2 achet√©es)

  amount Int // Montant rembours√© pour CET article (en centimes)
  // Permet de rembourser moins que le prix d'achat si d√©cote appliqu√©e

  // Gestion de stock
  restock Boolean @default(true) // Faut-il remettre le produit en stock (inventory +1) ?
  // false si le produit est ab√Æm√©/cass√©

  createdAt DateTime @default(now())

  @@index([refundId])
  @@index([orderItemId])
}

// ============================================================================
// AUDIT & CONFORMIT√â L√âGALE (Art. L123-22 Code de Commerce - Conservation 10 ans)
// ============================================================================

/// Journal d'audit pour tra√ßabilit√© des modifications sur entit√©s critiques
/// Requis pour conformit√© comptable fran√ßaise (conservation 10 ans)
model AuditLog {
  id String @id @default(cuid())

  // Entit√© concern√©e
  entityType String // "Order", "Refund", "Payment", "Product", etc.
  entityId   String // ID de l'entit√© modifi√©e

  // Action effectu√©e
  action String // "created", "updated", "deleted", "status_changed"

  // Donn√©es avant/apr√®s modification (pour rollback √©ventuel)
  previousData Json? // √âtat avant modification
  newData      Json? // √âtat apr√®s modification
  changedFields String[] // Liste des champs modifi√©s

  // Contexte de l'action
  changedBy String? // userId ou "system" ou "webhook"
  source    String? // "admin", "webhook", "api", "cron"
  ipAddress String? // IP de l'utilisateur (RGPD : anonymiser apr√®s 1 an)
  userAgent String? // User-Agent pour debug

  createdAt DateTime @default(now())

  @@index([entityType, entityId])
  @@index([entityType, createdAt])
  @@index([changedBy])
  @@index([createdAt])
}

/// Historique des changements de statut des commandes
/// Permet de tracer les transitions (ex: PENDING ‚Üí PAID ‚Üí SHIPPED ‚Üí DELIVERED)
model OrderStatusHistory {
  id String @id @default(cuid())

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Transition de statut
  field          String       // "status", "paymentStatus", "fulfillmentStatus"
  previousStatus String? // Statut avant (null si cr√©ation)
  newStatus      String // Nouveau statut

  // Contexte
  changedBy String? // userId, "system", "webhook:checkout.session.completed"
  reason    String? // Raison du changement (ex: "Paiement re√ßu via Stripe")

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([orderId, createdAt])
  @@index([field, createdAt])
}

// ============================================================================
// WEBHOOKS STRIPE - D√âDUPLICATION & AUDIT
// ============================================================================

enum WebhookEventStatus {
  PENDING // Re√ßu, en cours de traitement
  PROCESSED // Trait√© avec succ√®s
  FAILED // √âchec de traitement
  SKIPPED // Ignor√© (d√©j√† trait√© ou non pertinent)
}

/// Table de d√©duplication des √©v√©nements Stripe
/// √âvite le double traitement lors des retries webhook (Stripe renvoie apr√®s timeout)
model StripeWebhookEvent {
  id String @id @default(cuid())

  // Identifiant unique Stripe de l'√©v√©nement
  stripeEventId String @unique // evt_xxx

  // Type d'√©v√©nement
  type String // "checkout.session.completed", "charge.refunded", etc.

  // Statut de traitement
  status WebhookEventStatus @default(PENDING)

  // Entit√© li√©e (pour r√©conciliation)
  orderId  String? // Si li√© √† une commande
  refundId String? // Si li√© √† un remboursement

  // Donn√©es brutes (pour debug/replay)
  payload Json? // Corps de l'√©v√©nement Stripe

  // Erreur √©ventuelle
  errorMessage String? @db.Text
  retryCount   Int     @default(0)

  // Timestamps
  processedAt DateTime?
  createdAt   DateTime  @default(now())

  @@index([stripeEventId])
  @@index([type, status])
  @@index([orderId])
  @@index([status, createdAt])
  @@index([createdAt])
}

// ============================================================================
// PR√âPARATION TVA R√âGIME R√âEL (Seuil 85 000‚Ç¨)
// ============================================================================

/// Enregistrements TVA par pays (pour passage futur au r√©gime r√©el)
/// G√®re les immatriculations TVA (France, OSS pour UE, IOSS pour imports)
model TaxRegistration {
  id String @id @default(cuid())

  // Pays d'immatriculation (ISO alpha-2)
  country String @db.VarChar(2) // FR, DE, IT, ES, etc.

  // Num√©ro de TVA intracommunautaire
  registrationNumber String // FR35839183027

  // Type d'enregistrement
  // - "standard" : TVA nationale (France)
  // - "oss" : One-Stop-Shop pour ventes UE B2C
  // - "ioss" : Import One-Stop-Shop pour imports hors UE
  registrationType String @default("standard") @db.VarChar(20)

  // P√©riode de validit√©
  effectiveFrom DateTime
  effectiveTo   DateTime?

  // Statut
  active Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([country, registrationType])
  @@index([active])
  @@index([country])
}



