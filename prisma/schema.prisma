// ============================================================================
// CONFIGURATION
// ============================================================================

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// AUTH & USERS
// ============================================================================

enum Role {
  USER
  ADMIN
}

// === STATUT DE COMPTE (RGPD) ===
enum AccountStatus {
  ACTIVE
  INACTIVE
  PENDING_DELETION
  ANONYMIZED
}

model User {
  id               String    @id @default(cuid())
  role             Role      @default(USER)
  name             String?   @db.VarChar(100)
  email            String    @unique @db.VarChar(255)
  emailVerified    Boolean   @default(false)
  image            String?   @db.VarChar(2048)
  stripeCustomerId String?   @unique
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @default(now()) @updatedAt
  deletedAt        DateTime?
  suspendedAt      DateTime? // Date de suspension du compte

  // === STATUT DE COMPTE (RGPD) ===
  accountStatus AccountStatus @default(ACTIVE)

  // === CONSENTEMENT RGPD (avec versioning) ===
  termsAcceptedAt         DateTime? // Date d'acceptation des CGV
  termsVersion            String?   @db.VarChar(20) // Version CGV accept√©es (ex: "2024-11")
  privacyPolicyAcceptedAt DateTime? // Date d'acceptation de la politique de confidentialit√©
  privacyPolicyVersion    String?   @db.VarChar(20) // Version politique confidentialit√©

  // === M√âTADONN√âES INSCRIPTION ===
  signupIpAddress String? @db.VarChar(45) // IP lors de l'inscription (IPv6 max 45 chars)
  signupUserAgent String? @db.Text        // Browser/device info
  signupSource    String? @db.VarChar(50) // 'website', 'mobile', 'checkout'

  // === CONSENTEMENT MARKETING (s√©par√© de la newsletter) ===
  marketingEmailConsentedAt DateTime?
  marketingConsentSource    String?   @db.VarChar(100)

  // === ANONYMISATION RGPD ===
  anonymizedAt        DateTime? // Date d'anonymisation effective
  deletionRequestedAt DateTime? // Demande de suppression enregistr√©e

  sessions                  Session[]
  accounts                  Account[]
  orders                    Order[]
  cart                      Cart?
  addresses                 Address[]
  wishlist                  Wishlist?
  discountUsages            DiscountUsage[]
  stockNotificationRequests StockNotificationRequest[]
  newsletterSubscription    NewsletterSubscriber?

  // Relations avec les remboursements (audit)
  refundsCreated       Refund[]        @relation("RefundCreator")
  refundHistoryActions RefundHistory[] @relation("RefundHistoryAuthor")

  // Avis produits
  reviews ProductReview[]

  @@index([suspendedAt])
  @@index([role, id])
  @@index([emailVerified, id])
  @@index([createdAt, id])
  // Note: Les 2 index composites commen√ßant par deletedAt couvrent les queries sur deletedAt seul
  // PostgreSQL utilise le leading column d'un index composite pour les queries mono-colonne
  @@index([deletedAt, role]) // Admin: filtrer users actifs par r√¥le
  @@index([deletedAt, emailVerified]) // Admin: filtrer users actifs par statut email
  @@index([accountStatus])
  @@index([deletionRequestedAt])
  @@index([anonymizedAt])
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId, expiresAt]) // Couvre aussi userId seul
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@index([providerId, accountId])
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@index([identifier])
}

model Address {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  firstName  String
  lastName   String
  address1   String
  address2   String?
  postalCode String  @db.VarChar(10)
  city       String
  country    String  @default("FR") @db.VarChar(2)
  phone      String

  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Note: Contrainte unique partielle ajout√©e via migration SQL brute
  // pour garantir qu'un seul enregistrement a isDefault: true par userId

  @@index([userId, isDefault]) // Couvre aussi userId seul
  @@index([userId, createdAt(sort: Desc)])
}

// ============================================================================
// CATALOGUE - ENUMS
// ============================================================================

enum ProductStatus {
  DRAFT
  PUBLIC
  ARCHIVED
}

enum CollectionStatus {
  DRAFT
  PUBLIC
  ARCHIVED
}

enum MediaType {
  IMAGE
  VIDEO
}

/// Statut de mod√©ration des avis produits
enum ReviewStatus {
  PUBLISHED // Auto-publi√© (d√©faut)
  HIDDEN    // Masqu√© par mod√©ration (spam, inappropri√©, etc.)
}

// ============================================================================
// CATALOGUE - ENUMS ADDITIONNELS (Audit Fix)
// ============================================================================

enum CurrencyCode {
  EUR
  USD
  GBP
  CHF
}

enum ShippingCarrier {
  COLISSIMO
  CHRONOPOST
  MONDIAL_RELAY
  DPD
  OTHER
}

enum ShippingMethod {
  STANDARD
  EXPRESS
  PICKUP_POINT
  STORE_PICKUP
  // Zones de livraison (compatibilit√© r√©troactive)
  METROPOLITAN
  CORSE
  DOM
  TOM
}

// ============================================================================
// CATALOGUE - R√âF√âRENTIELS
// ============================================================================

model ProductType {
  id          String  @id @default(cuid())
  slug        String  @unique
  label       String  @db.VarChar(50)
  description String? @db.Text
  isActive    Boolean @default(true)
  isSystem    Boolean @default(false) // Types syst√®me non modifiables/supprimables

  products              Product[]
  customizationRequests CustomizationRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([label, id])
}

model Color {
  id        String       @id @default(cuid())
  slug      String       @unique
  name      String       @unique @db.VarChar(100)
  hex       String       @db.VarChar(7)
  isActive  Boolean      @default(true) // Coh√©rence avec Material
  skus      ProductSku[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name, id])
  @@index([isActive])
}

model Material {
  id          String       @id @default(cuid())
  slug        String       @unique
  name        String       @unique @db.VarChar(100)
  description String?      @db.Text
  isActive    Boolean      @default(true)
  skus        ProductSku[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name, id])
  @@index([isActive])
}

// ============================================================================
// CATALOGUE - COLLECTIONS
// ============================================================================

model Collection {
  id          String           @id @default(cuid())
  name        String           @db.VarChar(100)
  slug        String           @unique
  description String?          @db.Text
  status      CollectionStatus @default(DRAFT)

  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt
  products  ProductCollection[]

  @@index([name, id])
  @@index([createdAt, id])
  @@index([status, id])
}

/// Table de jointure explicite Product <-> Collection (many-to-many)
/// Permet √† un produit d'appartenir √† plusieurs collections
model ProductCollection {
  id           String     @id @default(cuid())
  productId    String
  product      Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  collectionId String
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  /// Date d'ajout √† la collection (pour tri automatique par nouveaut√©s)
  addedAt DateTime @default(now())

  /// Produit mis en avant dans la collection (pour hero/banner)
  /// Un seul produit peut √™tre featured par collection (g√©r√© c√¥t√© applicatif)
  isFeatured Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// Un produit ne peut appartenir qu'une seule fois √† une collection
  @@unique([productId, collectionId])
  @@index([collectionId, addedAt(sort: Desc)])
  @@index([productId])
  @@index([collectionId, isFeatured])
}

// ============================================================================
// CATALOGUE - PRODUITS & SKUs
// ============================================================================

model Product {
  id          String        @id @default(cuid())
  slug        String        @unique
  title       String        @db.VarChar(200)
  description String?       @db.Text
  status      ProductStatus @default(PUBLIC)

  type   ProductType? @relation(fields: [typeId], references: [id], onDelete: SetNull)
  typeId String?

  collections ProductCollection[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete pour pr√©server historique commandes

  skus       ProductSku[]
  orderItems OrderItem[]

  customizationInspirations CustomizationRequest[] @relation("CustomizationInspirations")

  // Avis produits
  reviews     ProductReview[]
  reviewStats ProductReviewStats?

  // Wishlist
  wishlistItems WishlistItem[]

  @@index([title, id])
  @@index([typeId])
  @@index([createdAt, id])
  @@index([deletedAt, status]) // Couvre aussi deletedAt seul
  @@index([status, createdAt(sort: Desc)]) // Nouveaut√©s, couvre aussi status seul
  @@index([typeId, status]) // Filtrage par type
}

model ProductSku {
  id        String  @id @default(cuid())
  sku       String  @unique @db.VarChar(100)
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  colorId  String?
  color    Color?  @relation(fields: [colorId], references: [id], onDelete: SetNull)

  materialId String?
  material   Material? @relation(fields: [materialId], references: [id], onDelete: SetNull)

  size String? @db.VarChar(50)

  // ‚ÑπÔ∏è Prix en r√©gime micro-entreprise (exon√©r√© de TVA - art. 293 B du CGI)
  // Le nom "priceInclTax" est conserv√© pour compatibilit√©, mais il s'agit du prix FINAL sans TVA
  // Exemple : 30‚Ç¨ = 3000 centimes (prix que paie le client, sans TVA ajout√©e)
  priceInclTax   Int
  compareAtPrice Int? // Prix avant r√©duction (optionnel, pour afficher prix barr√©)
  inventory      Int     @default(0)
  isActive       Boolean @default(true)

  isDefault Boolean @default(false)

  images                    SkuMedia[]
  orderItems                OrderItem[]
  cartItems                 CartItem[]
  stockNotificationRequests StockNotificationRequest[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete pour pr√©server historique commandes

  // üîí CONTRAINTE : Garantir unicit√© des combinaisons produit/couleur/taille/mat√©riau
  // √âvite les doublons de variantes (ex: 2 SKUs "Bague Rouge Taille 52 Argent")
  @@unique([productId, colorId, size, materialId])
  // Indexes optimis√©s pour requ√™tes fr√©quentes
  @@index([productId, isActive, inventory]) // Stock actif par produit, couvre aussi [productId, isActive]
  @@index([isActive, inventory, updatedAt(sort: Desc)])
  @@index([isActive, priceInclTax])
  @@index([productId, isDefault])
  @@index([colorId, isActive]) // Filtrage catalogue par couleur
  @@index([materialId, isActive]) // Filtrage catalogue par mat√©riau
  @@index([deletedAt])
  @@index([productId, isActive, deletedAt])
  @@index([isActive, inventory, priceInclTax]) // Covering index calcul valeur stock
}

model SkuMedia {
  id    String     @id @default(cuid())
  skuId String
  sku   ProductSku @relation(fields: [skuId], references: [id], onDelete: Cascade)

  url          String  @db.VarChar(2048)
  thumbnailUrl String? @db.VarChar(2048) // Thumbnail pour vid√©os (poster)
  blurDataUrl  String? @db.Text          // Base64 blur placeholder (~200 bytes)
  altText      String?
  mediaType    MediaType @default(IMAGE)
  isPrimary    Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([skuId, isPrimary])
  @@index([skuId, mediaType]) // Filtrage vid√©o/image
}

// ============================================================================
// PANIER
// ============================================================================

model Cart {
  id String @id @default(cuid())

  userId    String? @unique
  user      User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId String? @unique

  expiresAt DateTime?

  items CartItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([expiresAt])
  @@index([userId])
  @@index([sessionId])
  @@index([createdAt, userId]) // Dashboard: abandon de panier
}

model CartItem {
  id     String @id @default(cuid())
  cartId String
  cart   Cart   @relation(fields: [cartId], references: [id], onDelete: Cascade)

  skuId String
  sku   ProductSku @relation(fields: [skuId], references: [id], onDelete: Restrict)

  quantity Int @default(1)

  // Prix snapshot au moment de l'ajout au panier (en centimes)
  // Prot√®ge contre les changements de prix entre l'ajout et le paiement
  // Exemple: 29,99‚Ç¨ = 2999 centimes
  priceAtAdd Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, skuId])
  @@index([cartId])
  @@index([skuId])
}

// ============================================================================
// WISHLIST (FAVORIS)
// ============================================================================

model Wishlist {
  id String @id @default(cuid())

  // Support utilisateur connect√© OU session invit√©
  userId    String? @unique
  user      User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId String? @unique // UUID pour sessions invit√© (cookie httpOnly)

  // Date d'expiration pour les wishlists invit√© (null = utilisateur connect√©)
  expiresAt DateTime?

  items WishlistItem[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete (RGPD - Art. L123-22 Code de Commerce : 10 ans)

  @@index([expiresAt]) // Pour le nettoyage des wishlists expir√©es
  @@index([userId])
  @@index([sessionId])
  @@index([deletedAt])
}

model WishlistItem {
  id         String   @id @default(cuid())
  wishlistId String
  wishlist   Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete (RGPD - Art. L123-22 Code de Commerce : 10 ans)

  // Un produit ne peut √™tre ajout√© qu'une seule fois par wishlist
  @@unique([wishlistId, productId])
  @@index([wishlistId])
  @@index([productId])
  @@index([deletedAt])
}

// ============================================================================
// COMMANDES - ENUMS
// ============================================================================

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  PARTIALLY_REFUNDED
  REFUNDED
}

enum PaymentMethod {
  CARD
  BANK_TRANSFER
  PAYPAL
  OTHER
}

enum FulfillmentStatus {
  UNFULFILLED
  PROCESSING
  SHIPPED
  DELIVERED
  RETURNED
}

/// Cat√©gorie d'op√©ration (conformit√© fiscale fran√ßaise depuis juillet 2024)
enum OperationCategory {
  GOODS    // Vente de biens
  SERVICES // Prestations de services
  MIXED    // Mixte (biens + services)
}

/// Actions tra√ßables sur les commandes (audit trail)
/// Requis pour conformit√© l√©gale (Art. L123-22 Code de Commerce)
enum OrderAction {
  CREATED          // Cr√©ation de la commande
  PAID             // Paiement re√ßu
  PROCESSING       // Mise en pr√©paration
  SHIPPED          // Exp√©dition
  DELIVERED        // Livraison confirm√©e
  CANCELLED        // Annulation
  RETURNED         // Retour client
  STATUS_REVERTED  // Retour √† un statut pr√©c√©dent
  NOTE_ADDED       // Note ajout√©e
  NOTE_DELETED     // Note supprim√©e
  TRACKING_UPDATED // Suivi mis √† jour
  MANUAL_EDIT      // Modification manuelle admin
}

// ============================================================================
// COMMANDES - MODELS
// ============================================================================

model Order {
  id          String  @id @default(cuid())
  orderNumber String  @unique @db.VarChar(50)
  userId      String?
  user        User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // === IDENTIFIANTS STRIPE (CRITIQUES) ===
  stripeCheckoutSessionId String? @unique // cs_xxx
  stripePaymentIntentId   String? @unique // pi_xxx
  stripeChargeId          String? // ch_xxx
  stripeCustomerId        String? // cus_xxx
  // ‚ö†Ô∏è PR√âPARATION TVA R√âGIME R√âEL : Champ conserv√© pour future activation de Stripe Tax
  // En micro-entreprise (CA < 91 900‚Ç¨/an), ce champ reste null
  // Si passage en r√©gime r√©el TVA (> seuil), activer Stripe Tax et ce champ sera rempli
  stripeTaxCalculationId  String? // txcalc_xxx - ID Stripe Tax pour r√©conciliation

  // === INFORMATIONS CLIENT ===
  customerEmail String @db.VarChar(255)
  customerName  String @db.VarChar(200)
  customerPhone String?

  // === ADRESSE DE LIVRAISON (D√âNORMALIS√âE - SNAPSHOT) ===
  shippingFirstName  String
  shippingLastName   String
  shippingAddress1   String
  shippingAddress2   String?
  shippingPostalCode String  @db.VarChar(10)
  shippingCity       String
  shippingCountry    String  @default("FR") @db.VarChar(2)
  shippingPhone      String

  // === MONTANTS (EN CENTIMES) ===
  subtotal       Int
  discountAmount Int          @default(0) // Montant total des r√©ductions appliqu√©es
  taxAmount      Int          @default(0) // ‚ùå Micro-entreprise : Toujours 0 (exon√©r√©e de TVA - art. 293 B du CGI)
  shippingCost   Int          @default(0) // Frais de livraison
  total          Int // Formule: MAX(0, subtotal - discountAmount + shippingCost + taxAmount)
  currency       CurrencyCode @default(EUR)

  // === D√âTAILS FISCAUX (INUTILIS√âS EN MICRO-ENTREPRISE) ===
  // ‚ö†Ô∏è Ces champs sont conserv√©s pour compatibilit√© et future migration en r√©gime r√©el TVA
  // En micro-entreprise (CA < 91 900‚Ç¨/an), ces champs restent null ou 0
  // Si passage en r√©gime r√©el TVA (> seuil), r√©activer Stripe Tax et ces champs seront remplis
  taxRate         Decimal? @db.Decimal(5, 4) // ‚ùå Micro-entreprise : null (pas de TVA)
  taxJurisdiction String? // ‚ùå Micro-entreprise : null
  taxType         String? // ‚ùå Micro-entreprise : null
  taxDetails      Json? // ‚ùå Micro-entreprise : null (pas de Stripe Tax)

  // === PR√âPARATION R√âGIME R√âEL TVA ===
  // Ces champs pr√©parent la migration vers le r√©gime r√©el TVA (seuil 85 000‚Ç¨)
  customerTaxId          String?  // N¬∞ TVA client B2B (ex: FR12345678901 pour ventes B2B)
  taxBehavior            String   @default("inclusive") // Stripe Tax: "inclusive" ou "exclusive"
  reverseCharge          Boolean  @default(false) // Autoliquidation TVA pour ventes B2B UE
  stripeTaxTransactionId String?  // tax_txn_xxx - ID permanent pour reporting fiscal (txcalc_ expire 90j)
  customerTaxIdVerified  Boolean  @default(false) // R√©sultat validation VIES (TVA intracommunautaire)
  taxExempt              Boolean  @default(false) // Client exon√©r√© de TVA

  // === √âCHECS DE PAIEMENT ===
  // Stocke les codes d'erreur du dernier √©chec (historique complet dans WebhookEvent)
  paymentFailureCode    String? @db.VarChar(100) // Code Stripe: "card_declined", "expired_card", etc.
  paymentDeclineCode    String? @db.VarChar(100) // Code r√©seau d√©taill√© (Visa/MC)
  paymentFailureMessage String? // Message lisible pour debug

  // === LIVRAISON ===
  shippingMethod    ShippingMethod?  // Type de livraison
  shippingCarrier   ShippingCarrier? // Transporteur
  shippingRateId    String? // ID du tarif Stripe utilis√©
  trackingNumber    String? @db.VarChar(50)
  trackingUrl       String? // URL de suivi
  estimatedDelivery DateTime? // Date estim√©e de livraison
  actualDelivery    DateTime? // Date r√©elle de livraison
  shippedAt         DateTime? // Date d'exp√©dition

  // === EMAIL INCITATIF AVIS ===
  reviewRequestSentAt DateTime? // Date d'envoi de l'email de demande d'avis

  // === STATUTS ===
  status            OrderStatus       @default(PENDING)
  paymentStatus     PaymentStatus     @default(PENDING)
  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED)

  // === PAIEMENT ===
  paymentMethod PaymentMethod @default(CARD)
  paidAt        DateTime?

  // === CONFORMIT√â L√âGALE FRAN√áAISE ===
  // Obligation de conservation 10 ans (Art. L123-22 Code de commerce)
  operationCategory OperationCategory @default(GOODS) // Conformit√© fiscale depuis juillet 2024
  fiscalYear        Int? // Ann√©e fiscale de la commande

  // === RELATIONS ===
  items          OrderItem[]
  discountUsages DiscountUsage[]
  refunds        Refund[]
  notes          OrderNote[]
  history        OrderHistory[] // üî¥ Audit trail (conformit√© l√©gale)

  // === SOFT DELETE (Conformit√© l√©gale - Conservation 10 ans) ===
  // Ne JAMAIS supprimer physiquement une commande (Art. L123-22 Code de Commerce)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // === INDEXES OPTIMIS√âS ===
  @@index([userId])
  // Statuts (index composites uniquement)
  @@index([status, id])
  @@index([paymentStatus, id])
  @@index([fulfillmentStatus, id])
  // Chronologique
  @@index([userId, createdAt(sort: Desc)])
  @@index([userId, paymentStatus, createdAt(sort: Desc)]) // Covering index "Mes commandes"
  @@index([status, createdAt])
  @@index([customerEmail]) // Recherche support client
  @@index([deletedAt]) // Soft delete filter
  @@index([deletedAt, status, createdAt]) // Index composite pour listings admin (soft-delete + status)
  // Timestamps m√©tier
  @@index([shippedAt, fulfillmentStatus]) // Timeline exp√©ditions
  @@index([paidAt, paymentStatus]) // Rapports comptables
  @@index([paidAt(sort: Desc), paymentStatus, deletedAt]) // Covering index: requetes popularite/bestsellers
  @@index([fiscalYear, paymentStatus])

  // === INDEXES STRIPE (R√©conciliation & Support) ===
  @@index([stripePaymentIntentId])
  @@index([stripeCheckoutSessionId])
  @@index([stripeCustomerId])
  @@index([stripeChargeId]) // Recherche remboursements
  @@index([createdAt(sort: Desc)]) // Listing commandes r√©centes
}

/// Historique des actions sur les commandes (audit trail)
/// Obligatoire pour conformit√© l√©gale fran√ßaise (Art. L123-22 Code de Commerce)
/// Conservation 10 ans avec la commande
/// ‚ö†Ô∏è AUDIT FIX: onDelete: SetNull pour pr√©server l'audit trail m√™me si commande supprim√©e
model OrderHistory {
  id      String  @id @default(cuid())
  orderId String?
  order   Order?  @relation(fields: [orderId], references: [id], onDelete: SetNull)

  /// Action effectu√©e sur la commande
  action OrderAction

  /// Statuts avant/apr√®s pour les changements de statut
  previousStatus            OrderStatus?
  newStatus                 OrderStatus?
  previousPaymentStatus     PaymentStatus?
  newPaymentStatus          PaymentStatus?
  previousFulfillmentStatus FulfillmentStatus?
  newFulfillmentStatus      FulfillmentStatus?

  /// Note explicative (ex: raison annulation, commentaire admin)
  note String? @db.Text

  /// M√©tadonn√©es suppl√©mentaires (JSON flexible pour donn√©es additionnelles)
  metadata Json?

  /// Auteur de l'action
  authorId   String? // ID de l'admin ou null pour actions syst√®me
  authorName String? @db.VarChar(100) // D√©normalis√© pour audit (si admin supprim√© plus tard)

  /// Source de l'action
  source String @default("admin") // "admin" | "webhook" | "system" | "customer"

  /// Timestamp de l'action
  createdAt DateTime @default(now())

  // === INDEXES ===
  // Note: @@index([orderId]) supprim√© (couvert par composite)
  @@index([orderId, createdAt(sort: Desc)])
  @@index([action])
  @@index([authorId])
  @@index([createdAt(sort: Desc)])
}

model OrderItem {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // ‚ö†Ô∏è onDelete: NoAction - Pr√©serve l'historique des ventes pour le calcul des bestsellers
  // Un produit avec commandes ne peut pas √™tre supprim√© physiquement (utiliser soft-delete)
  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: NoAction)

  // ‚ö†Ô∏è onDelete: Restrict intentionnel - Un SKU avec commandes ne peut pas √™tre supprim√©
  // Garantit l'int√©grit√© comptable (Art. L123-22 Code de commerce - conservation 10 ans)
  // Pour "supprimer" un SKU : utiliser le soft-delete sur Product ou archiver le SKU
  skuId String
  sku   ProductSku @relation(fields: [skuId], references: [id], onDelete: Restrict)

  // Snapshot des donn√©es produit au moment de la commande
  productTitle       String
  productDescription String? @db.Text
  productImageUrl    String?

  skuColor    String?
  skuMaterial String?
  skuSize     String?
  skuImageUrl String?

  // Prix et quantit√©
  price    Int // ‚ÑπÔ∏è Prix unitaire FINAL sans TVA en centimes (micro-entreprise exon√©r√©e)
  quantity Int

  // D√©tails fiscaux (inutilis√©s en micro-entreprise)
  // ‚ö†Ô∏è Conserv√©s pour compatibilit√© et future migration en r√©gime r√©el TVA
  taxAmount Int      @default(0) // ‚ùå Micro-entreprise : Toujours 0 (pas de TVA)
  taxRate   Decimal? @db.Decimal(5, 4) // ‚ùå Micro-entreprise : null (pas de TVA)

  // Relations
  refundItems RefundItem[]

  // Avis produit (un OrderItem peut avoir un avis, relation 1:1)
  review ProductReview?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([productId])
  @@index([skuId])
  @@index([productId, orderId]) // Analytics top produits
}

/// Notes internes sur les commandes (visibles uniquement par les admins)
/// Permet de documenter les √©changes clients, incidents, ou actions sp√©ciales
model OrderNote {
  id String @id @default(cuid())

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Contenu de la note
  content String @db.Text

  // Admin qui a cr√©√© la note
  authorId   String
  authorName String @db.VarChar(100) // D√©normalis√© pour historique si admin supprim√©

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime? // Soft delete pour audit trail

  @@index([orderId, createdAt(sort: Desc)])
  @@index([authorId, createdAt(sort: Desc)]) // Historique activit√© admin
  @@index([deletedAt])
}

// ============================================================================
// REMBOURSEMENTS
// ============================================================================

enum RefundReason {
  CUSTOMER_REQUEST // Droit de r√©tractation (14 jours)
  DEFECTIVE        // Bijou cass√© / ab√Æm√©
  WRONG_ITEM       // Erreur de pr√©paration de commande
  LOST_IN_TRANSIT  // Colis perdu par le transporteur
  FRAUD            // Fraude av√©r√©e
  OTHER            // Autre
}

enum RefundStatus {
  PENDING   // Demande re√ßue / En attente de validation
  APPROVED  // Valid√©, en attente de traitement Stripe
  COMPLETED // Rembours√© effectivement (Stripe a confirm√©)
  REJECTED  // Refus√© (ex: retour hors d√©lai)
  FAILED    // √âchec technique Stripe
  CANCELLED // Annul√© par l'admin (soft delete)
}

// === Actions de l'historique des remboursements ===
enum RefundAction {
  CREATED   // Cr√©ation de la demande
  APPROVED  // Approbation de la demande
  REJECTED  // Rejet de la demande
  PROCESSED // Envoi vers Stripe
  COMPLETED // Remboursement confirm√© par Stripe
  FAILED    // √âchec du remboursement Stripe
  CANCELLED // Annulation de la demande
}

model Refund {
  id String @id @default(cuid())

  // Relation avec la commande (Restrict pour protection comptable)
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Restrict)

  // Identifiant Stripe du remboursement (pour lier la compta)
  stripeRefundId String? @unique // re_xxxx

  // Montants
  amount   Int          // Montant TOTAL rembours√© en centimes
  currency CurrencyCode @default(EUR)

  // Raison et Statut
  reason        RefundReason
  status        RefundStatus @default(PENDING)
  failureReason String?      // D√©tail si FAILED (ex: "insufficient_funds", "charge_already_refunded")

  // Note interne (ex: "Le fermoir √©tait cass√©, photos re√ßues par mail")
  note String? @db.Text

  // D√©tails des articles rembours√©s
  items RefundItem[]

  // Audit
  createdBy     String? // ID de l'admin qui a cr√©√© le remboursement
  createdByUser User?   @relation("RefundCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  processedAt   DateTime? // Date de traitement effectif (Stripe)

  // Historique des actions
  history RefundHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // === SOFT DELETE (Conformit√© l√©gale - Conservation 10 ans) ===
  // Ne JAMAIS supprimer physiquement un remboursement (Art. L123-22 Code de Commerce)
  deletedAt DateTime?

  @@index([orderId])
  @@index([createdAt(sort: Desc)])
  @@index([status, createdAt]) // Couvre aussi status seul
  @@index([status, processedAt]) // Dashboard: stats remboursements par periode
  @@index([deletedAt])
}

model RefundItem {
  id String @id @default(cuid())

  refundId String
  refund   Refund @relation(fields: [refundId], references: [id], onDelete: Cascade)

  // Lien pr√©cis vers la ligne de commande d'origine
  // Cela permet de savoir quel produit exact (et √† quel prix d'origine) est rembours√©
  orderItemId String
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Restrict)

  quantity Int // Nombre d'unit√©s rembours√©es (ex: 1 sur 2 achet√©es)

  amount Int // Montant rembours√© pour CET article (en centimes)
  // Permet de rembourser moins que le prix d'achat si d√©cote appliqu√©e

  // Gestion de stock
  restock Boolean @default(true) // Faut-il remettre le produit en stock (inventory +1) ?
  // false si le produit est ab√Æm√©/cass√©

  createdAt DateTime @default(now())

  @@index([refundId])
  @@index([orderItemId])
}

// === Historique des actions sur les remboursements ===
/// ‚ö†Ô∏è AUDIT FIX: onDelete: SetNull pour pr√©server l'audit trail m√™me si remboursement supprim√©
model RefundHistory {
  id String @id @default(cuid())

  refundId String?
  refund   Refund? @relation(fields: [refundId], references: [id], onDelete: SetNull)

  action RefundAction

  // Note optionnelle (ex: raison du rejet)
  note String? @db.Text

  // Auteur de l'action (admin ou syst√®me via webhook)
  authorId String?
  author   User?   @relation("RefundHistoryAuthor", fields: [authorId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([refundId, createdAt]) // Couvre aussi refundId seul
}

// ============================================================================
// CODES PROMO & R√âDUCTIONS
// ============================================================================

enum DiscountType {
  PERCENTAGE   // Ex: -20%
  FIXED_AMOUNT // Ex: -10‚Ç¨
}

model Discount {
  id   String @id @default(cuid())
  code String @unique @db.VarChar(30) // Ex: "BIENVENUE10", "ETE2025"

  // Type et valeur de la r√©duction
  type  DiscountType
  value Int // En pourcentage (20 = 20%) ou centimes (1000 = 10‚Ç¨)

  // Conditions d'utilisation
  minOrderAmount  Int? // Montant minimum de commande en centimes (ex: 5000 = 50‚Ç¨)
  maxUsageCount   Int? // Nombre max d'utilisations total (null = illimit√©)
  maxUsagePerUser Int? // Nombre max d'utilisations par utilisateur (null = illimit√©)

  // P√©riode de validit√©
  startsAt DateTime  @default(now())
  endsAt   DateTime?

  // Statistiques
  usageCount Int @default(0) // Compteur d'utilisations

  // √âtat
  isActive Boolean @default(true)

  // Restrictions optionnelles (√† impl√©menter si besoin)
  // appliesToCollectionId String?
  // appliesToProductId    String?
  // firstOrderOnly        Boolean @default(false)

  // Relations
  usages DiscountUsage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code, isActive]) // Validation code promo actif, couvre aussi code seul
  @@index([isActive, startsAt, endsAt])
  @@index([createdAt, id])
}

model DiscountUsage {
  id         String   @id @default(cuid())
  discountId String
  discount   Discount @relation(fields: [discountId], references: [id], onDelete: Cascade)

  // Utilisateur (optionnel pour guest checkout)
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Commande associ√©e (Restrict pour protection comptable)
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Restrict)

  // Montant de la r√©duction appliqu√©e (snapshot)
  amountApplied Int // En centimes

  createdAt DateTime @default(now())
  deletedAt DateTime? // Soft delete pour audit trail comptable

  @@index([orderId])
  @@index([discountId, userId]) // Pour v√©rifier usage par utilisateur, couvre aussi discountId seul
  @@index([userId, discountId, deletedAt]) // V√©rification limite par user avec soft-delete, couvre aussi userId seul
  @@index([deletedAt])
}

// ============================================================================
// NEWSLETTER
// ============================================================================

enum NewsletterStatus {
  PENDING      // En attente de confirmation (double opt-in)
  CONFIRMED    // Email confirm√©, abonnement actif
  UNSUBSCRIBED // D√©sabonn√©
}

model NewsletterSubscriber {
  id               String  @id @default(cuid())
  email            String  @unique
  unsubscribeToken String  @unique @default(cuid())

  // === STATUT NEWSLETTER ===
  status NewsletterStatus @default(PENDING)

  // Lien optionnel avec un compte utilisateur
  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Double opt-in : Confirmation email obligatoire
  emailVerified      Boolean   @default(false) // true apr√®s clic sur lien confirmation
  confirmationToken  String?   @unique // Token unique pour confirmer l'inscription
  confirmationSentAt DateTime? // Date d'envoi de l'email de confirmation
  confirmedAt        DateTime? // Date de confirmation par l'utilisateur

  // Champs de tra√ßabilit√© RGPD
  ipAddress             String? // IP inscription
  confirmationIpAddress String? // IP confirmation (preuve RGPD)
  userAgent             String?
  consentSource         String? @default("newsletter_form")
  consentTimestamp      DateTime @default(now())

  subscribedAt   DateTime  @default(now())
  unsubscribedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime? // Soft delete pour RGPD

  @@index([status, createdAt])
  @@index([emailVerified, status])
  @@index([userId])
  @@index([deletedAt])
  @@index([confirmedAt]) // Audit RGPD preuve de consentement
  @@index([confirmationToken])
  @@index([deletedAt, status, subscribedAt])
}

// ============================================================================
// NOTIFICATIONS RETOUR EN STOCK
// ============================================================================

enum StockNotificationStatus {
  PENDING   // En attente du retour en stock
  NOTIFIED  // Email envoy√© au client
  EXPIRED   // Demande expir√©e (apr√®s X jours sans retour)
  CANCELLED // Annul√©e par l'utilisateur
}

/// Demande de notification quand un produit revient en stock
/// Permet aux clients de s'inscrire pour √™tre notifi√©s du retour d'un SKU
model StockNotificationRequest {
  id String @id @default(cuid())

  // SKU concern√© (Cascade coh√©rent avec CartItem/WishlistItem)
  skuId String
  sku   ProductSku @relation(fields: [skuId], references: [id], onDelete: Cascade)

  // Utilisateur (optionnel : peut √™tre un visiteur non connect√©)
  userId String?
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Email du demandeur (obligatoire pour envoi notification)
  email String @db.VarChar(255)

  // Statut de la demande
  status StockNotificationStatus @default(PENDING)

  // Token unique pour d√©sinscription sans connexion
  unsubscribeToken String @unique @default(cuid())

  // Tracking envoi notification
  notifiedAt        DateTime? // Date d'envoi de l'email de notification
  notifiedInventory Int? // Stock disponible au moment de l'envoi

  // M√©tadonn√©es RGPD
  ipAddress String?
  userAgent String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime? // Soft delete pour RGPD

  // ‚ö†Ô∏è AUDIT FIX: Contrainte unicit√© au niveau DB (avant: g√©r√©e c√¥t√© applicatif)
  // Note: @@unique cr√©e automatiquement un index, pas besoin de @@index([email, skuId])
  @@unique([email, skuId])

  // Indexes pour performances
  @@index([skuId, status])
  @@index([email])
  @@index([userId])
  @@index([status, createdAt])
  @@index([email, createdAt(sort: Desc)]) // Historique demandes par email
  @@index([deletedAt]) // Soft delete filter RGPD
  @@index([notifiedAt(sort: Desc)]) // Analyse historique notifications
  @@index([status, deletedAt]) // Stats avec soft delete
  @@index([status, notifiedAt, deletedAt]) // notifiedThisMonth stat query
}

// ============================================================================
// AVIS PRODUITS
// ============================================================================

/// Avis produit laiss√© par un acheteur v√©rifi√©
/// Un seul avis par utilisateur et par produit (pas par OrderItem)
/// Permet de mettre √† jour l'avis apr√®s un nouvel achat
model ProductReview {
  id String @id @default(cuid())

  // === RELATIONS PRINCIPALES ===
  // Produit concern√© (relation vers Product, pas ProductSku)
  // Les avis sont au niveau produit, pas variante
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  // Auteur de l'avis (acheteur v√©rifi√©)
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Restrict)

  // Preuve d'achat : OrderItem du PREMIER achat ayant permis de laisser l'avis
  // Ce champ ne change pas lors des mises √† jour de l'avis (m√™me si rachat ult√©rieur)
  // Garantit que seuls les acheteurs v√©rifi√©s peuvent laisser un avis
  orderItemId String    @unique // Un OrderItem ne peut g√©n√©rer qu'un seul avis
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Restrict)

  // === CONTENU DE L'AVIS ===
  rating  Int     // Note de 1 √† 5 √©toiles (validation Zod c√¥t√© serveur)
  title   String? @db.VarChar(150) // Titre optionnel de l'avis
  content String  @db.Text // Commentaire texte

  // === MOD√âRATION ===
  status ReviewStatus @default(PUBLISHED) // Auto-publi√©, mod√©ration a posteriori

  // === RELATIONS ===
  medias   ReviewMedia[] // Photos de l'avis (max 3)
  response ReviewResponse? // R√©ponse admin (unique)

  // === TIMESTAMPS ===
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete RGPD (10 ans conservation)

  // === CONTRAINTES ===
  // Un utilisateur ne peut laisser qu'un seul avis par produit
  // S'il rach√®te le produit, il peut modifier son avis existant
  @@unique([userId, productId])

  // === INDEXES ===
  // Index composite principal pour affichage des avis d'un produit
  @@index([productId, status, deletedAt, createdAt(sort: Desc)])
  // Index pour page "Mes avis" du client
  @@index([userId, deletedAt, createdAt(sort: Desc)])
  // Index pour mod√©ration admin
  @@index([status, createdAt(sort: Desc)])
  // Index pour calcul des stats (rating) et filtrage par note
  @@index([productId, deletedAt, rating])
}

/// Photo jointe √† un avis produit
/// Maximum 3 photos par avis (validation applicative)
model ReviewMedia {
  id       String        @id @default(cuid())
  reviewId String
  review   ProductReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  // === MEDIA (Pattern SkuMedia) ===
  url         String  @db.VarChar(2048) // URL UploadThing
  blurDataUrl String? @db.Text // Base64 blur placeholder (~200 bytes)
  altText     String? @db.VarChar(255) // Alt text pour accessibilit√©

  // Position pour ordre d'affichage (0, 1, 2)
  position Int @default(0)

  // === TIMESTAMPS ===
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // === INDEXES ===
  @@index([reviewId, position])
}

/// R√©ponse de l'admin/marque √† un avis
/// Une seule r√©ponse possible par avis
model ReviewResponse {
  id       String        @id @default(cuid())
  reviewId String        @unique // Une seule r√©ponse par avis
  review   ProductReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  // === CONTENU ===
  content String @db.Text // R√©ponse texte de la marque

  // === AUTEUR ADMIN (Pattern OrderNote) ===
  // L'admin qui a r√©dig√© la r√©ponse
  authorId   String // ID de l'admin
  authorName String @db.VarChar(100) // D√©normalis√© pour historique si admin supprim√©

  // === TIMESTAMPS ===
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete RGPD

  // === INDEXES ===
  @@index([authorId, createdAt(sort: Desc)])
}

/// Statistiques agr√©g√©es des avis par produit
/// Table de cache pour performances (√©vite COUNT/AVG √† chaque requ√™te)
/// Mise √† jour via trigger applicatif apr√®s cr√©ation/modification/suppression d'avis
model ProductReviewStats {
  id        String  @id @default(cuid())
  productId String  @unique
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // === STATISTIQUES AGR√âG√âES ===
  totalCount    Int     @default(0) // Nombre total d'avis publi√©s
  averageRating Decimal @default(0) @db.Decimal(3, 2) // Moyenne (ex: 4.75)

  // Distribution des notes (pour graphique cliquable)
  rating1Count Int @default(0) // Nombre d'avis 1 √©toile
  rating2Count Int @default(0) // Nombre d'avis 2 √©toiles
  rating3Count Int @default(0) // Nombre d'avis 3 √©toiles
  rating4Count Int @default(0) // Nombre d'avis 4 √©toiles
  rating5Count Int @default(0) // Nombre d'avis 5 √©toiles

  // === TIMESTAMPS ===
  updatedAt DateTime @updatedAt

  // === INDEXES ===
  // Index pour tri par note moyenne (best rated products)
  @@index([averageRating(sort: Desc), totalCount(sort: Desc)])
  // Index pour filtrage produits avec avis
  @@index([totalCount])
}

// ============================================================================
// WEBHOOKS IDEMPOTENCY (Stripe)
// ============================================================================

enum WebhookEventStatus {
  PENDING    // Re√ßu, en attente de traitement
  PROCESSING // En cours de traitement
  COMPLETED  // Trait√© avec succ√®s
  FAILED     // √âchec du traitement
  SKIPPED    // Ignor√© (type non g√©r√© ou doublon)
}

/// √âv√©nements webhook Stripe
/// Permet l'idempotence et l'audit trail des webhooks
model WebhookEvent {
  id            String             @id @default(cuid())
  stripeEventId String             @unique // evt_xxx - Cl√© d'idempotence
  eventType     String             @db.VarChar(100) // checkout.session.completed, etc.
  status        WebhookEventStatus @default(PENDING)
  errorMessage  String?            @db.Text
  attempts      Int                @default(0)
  receivedAt    DateTime           @default(now())
  processedAt   DateTime?

  @@index([eventType, status])
  @@index([status, receivedAt])
  @@index([processedAt])
}

// ============================================================================
// DEMANDES DE PERSONNALISATION
// ============================================================================

enum CustomizationRequestStatus {
  PENDING     // Nouvelle demande
  IN_PROGRESS // En cours de traitement
  COMPLETED   // R√©alis√©
  CANCELLED   // Annul√©
}

/// Demande de personnalisation de bijou
/// Stocke les demandes clients pour cr√©ations sur mesure
model CustomizationRequest {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime? // Soft delete (RGPD - Art. L123-22 Code de Commerce : 10 ans)

  // === INFORMATIONS CONTACT ===
  firstName String  @db.VarChar(50)
  lastName  String  @db.VarChar(50)
  email     String  @db.VarChar(255)
  phone     String? @db.VarChar(20)

  // === TYPE DE PRODUIT ===
  productTypeLabel String       @db.VarChar(100) // Label du type s√©lectionn√© (snapshot)
  productType      ProductType? @relation(fields: [productTypeId], references: [id], onDelete: SetNull)
  productTypeId    String?

  // === INSPIRATIONS (produits existants comme r√©f√©rence) ===
  inspirationProducts Product[] @relation("CustomizationInspirations")

  // === DESCRIPTION ===
  details String @db.Text // Description d√©taill√©e de la demande

  // === STATUT ET SUIVI ===
  status      CustomizationRequestStatus @default(PENDING)
  adminNotes  String?                    @db.Text // Notes internes admin
  respondedAt DateTime?                          // Date de premi√®re r√©ponse

  @@index([status, createdAt(sort: Desc)])
  @@index([email])
  @@index([createdAt(sort: Desc)])
  @@index([deletedAt])
  @@index([deletedAt, status])
}

